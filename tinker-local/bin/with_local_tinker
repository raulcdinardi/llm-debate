#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd -- "${SCRIPT_DIR}/../.." && pwd)"

if [[ $# -lt 1 ]]; then
  echo "usage: with_local_tinker <command> [args...]" >&2
  exit 2
fi

backend="${TINKER_LOCAL_BACKEND:-transformers}"
if [[ "${backend}" == "unsloth" ]]; then
  echo "warning: TINKER_LOCAL_BACKEND=unsloth is unsupported; using transformers." >&2
  export TINKER_LOCAL_BACKEND="transformers"
elif [[ "${backend}" != "transformers" ]]; then
  echo "error: TINKER_LOCAL_BACKEND must be 'transformers'." >&2
  exit 2
fi
export TINKER_LOCAL_BACKEND="${backend}"

export TINKER_BACKEND="local"
export PYTHONPATH="${REPO_ROOT}/src${PYTHONPATH:+:${PYTHONPATH}}"
exec "$@"
