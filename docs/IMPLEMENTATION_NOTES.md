# Debate Environment - Implementation Notes

## Code Structure

4 layers, each building on the previous:

```
Layer 1: Data (frozen, pass around)
├── Question(text, correct, incorrect)
└── DebateState(question, transcript, turn, max_turns)

Layer 2: Pure Functions (no side effects, testable)
├── debater_prompt(state, debater_id, my_answer, their_answer) → str
├── judge_prompt(state) → str
└── compute_rewards(judge_said_a) → (float, float)

Layer 3: Async (fitting tinker's interface)
├── Coordinator (asyncio.Condition for turn sync)
├── DebateEnv (Env interface, delegates to Coordinator)
└── DebateGroup (EnvGroupBuilder, calls judge in compute_group_rewards)

Layer 4: Dataset (batching for training)
├── Dataset (RLDataset)
└── DatasetBuilder (RLDatasetBuilder with @chz.chz)
```

## Why This Structure

**Unix philosophy**: Each layer does one thing.
- Layer 2 is pure, can test without async or API
- Layer 3 is thin adapter to tinker
- Prompts are generated by functions, not embedded in classes

**Data flows down**: Question → State → Transcript → Judge → Rewards

**Easy to debug**: `run_mock_debate()` in debug.py exercises layer 2 directly.

## Key Design Decisions

| Decision | Choice | Why |
|----------|--------|-----|
| Who has correct answer | Always debater A | Simpler, metrics clearer |
| Reward structure | Zero-sum (+1/-1) | Matches game theory |
| When rewards computed | End of episode | Judge needs full transcript |
| Turn structure | Alternating | A→B→A→B→... |

## Tinker API (Quick Reference)

```
Env.initial_observation() → (ModelInput, StopCondition)
Env.step(tokens) → StepResult(reward, done, next_obs, stop, metrics)

EnvGroupBuilder.make_envs() → list[Env]
EnvGroupBuilder.compute_group_rewards(trajectories, envs) → list[(float, Metrics)]

RLDataset.get_batch(idx) → list[EnvGroupBuilder]
```

## Files

| File | Lines | Purpose |
|------|-------|---------|
| env.py | ~285 | Everything: types, functions, classes |
| train.py | ~55 | CLI wrapper |
| debug.py | ~100 | Mock testing, no API needed |
| README.md | ~50 | Usage |

## Running

```bash
# Debug (no API)
python -m tinker_cookbook.recipes.multiplayer_rl.debate.debug

# Train (needs TINKER_API_KEY)
python -m tinker_cookbook.recipes.multiplayer_rl.debate.train
```
